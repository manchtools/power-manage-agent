name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Checkout SDK
        uses: actions/checkout@v4
        with:
          repository: MANCHTOOLS/power-manage-sdk
          path: _sdk

      - name: Rewrite SDK replace directive
        run: go mod edit -replace github.com/manchtools/power-manage/sdk=./_sdk

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build agent
        env:
          CGO_ENABLED: '0'
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" \
            -o dist/power-manage-agent-linux-${{ matrix.arch }} ./cmd/power-manage-agent

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-${{ matrix.arch }}
          path: dist/

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp artifacts/agent-amd64/* release/
          cp artifacts/agent-arm64/* release/
          cp install.sh release/
          cd release && sha256sum * > SHA256SUMS

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Power Manage Agent ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: release/*
          body: |
            ## Installation

            ```bash
            curl -LO https://github.com/MANCHTOOLS/power-manage-agent/releases/download/${{ github.ref_name }}/power-manage-agent-linux-amd64
            curl -LO https://github.com/MANCHTOOLS/power-manage-agent/releases/download/${{ github.ref_name }}/install.sh
            chmod +x install.sh power-manage-agent-linux-amd64
            sudo mv power-manage-agent-linux-amd64 /usr/local/bin/power-manage-agent
            sudo ./install.sh -s https://your-server.example.com -t YOUR_TOKEN
            ```

            ## Binaries

            | Binary | Platform |
            |--------|----------|
            | `power-manage-agent-linux-amd64` | Linux x86_64 |
            | `power-manage-agent-linux-arm64` | Linux ARM64 |
